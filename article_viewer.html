<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>記事ビューア</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<header>
  <h1 id="articleTitle">記事タイトル</h1>
  <p class="meta">
    <span id="articleSource"></span>｜
    <span id="articleDate"></span>
    <span id="badgePrediction"></span>
  </p>
</header>

<main class="viewer-layout">

  <!-- 左：元記事 -->
  <section class="pane pane-left">
    <h2>元記事</h2>
    <div id="articleText"></div>
  </section>

  <!-- 中央：文メタデータ -->
  <section class="pane pane-center">
    <h2>文メタデータ</h2>
    <div id="claimsList"></div>
  </section>

  <!-- 右：方向性 -->
  <section class="pane pane-right">
    <h2>方向性</h2>

    <!-- 要約 -->
    <div class="summary-card">
      <h3>要約 & 予測内容</h3>
      <ul id="directionSummary"></ul>
    </div>

    <!-- Future Tree -->
    <div class="summary-card">
      <h3>Future Tree</h3>
      <pre id="futureTreeText"></pre>
    </div>

    <!-- 記事全体の分類内訳 -->
    <div class="summary-card">
      <h3>分類内訳（typeSummary）</h3>
      <ul id="typeSummaryList"></ul>
    </div>

  </section>

</main>

<script>
// ==================================================================
//   新スキーマ対応 article_viewer.js
// ==================================================================

document.addEventListener("DOMContentLoaded", () => {
  loadArticleForViewer();
});

// ------------------------------------------------------------
//   記事 JSON を読み込み
// ------------------------------------------------------------
async function loadArticleForViewer() {
  const params = new URLSearchParams(window.location.search);
  const file = params.get("file");

  if (!file) {
    document.getElementById("articleText").innerText = "ファイルが指定されていません。";
    return;
  }

  try {
    const response = await fetch(file);
    if (!response.ok) {
      document.getElementById("articleText").innerText =
        "記事 JSON を読み込めません：" + file;
      return;
    }

    const article = await response.json();
    renderArticle(article);

  } catch (err) {
    document.getElementById("articleText").innerText =
      "読み込みエラー：" + err;
  }
}


// ------------------------------------------------------------
//   記事の表示（新スキーマ）
// ------------------------------------------------------------
function renderArticle(article) {

  // ----- タイトル等 -----
  document.getElementById("articleTitle").innerText = article.title || "(タイトルなし)";
  document.getElementById("articleSource").innerText = article.source || "";
  document.getElementById("articleDate").innerText = article.date || "";

  // 予測バッジ
  if (article.hasPrediction) {
    document.getElementById("badgePrediction").innerHTML =
      `<span class="badge-pred">予測あり</span>`;
  } else {
    document.getElementById("badgePrediction").innerHTML =
      `<span class="badge-nopred">予測なし</span>`;
  }


  // ================================
  //   左ペイン：本文（article.text）
  // ================================
  const articleTextDiv = document.getElementById("articleText");
  articleTextDiv.innerHTML = "";

  if (article.text) {
    const sentences = article.text.split(/(?<=[。！？\?])/g);
    sentences.forEach(s => {
      const p = document.createElement("p");
      p.innerText = s.trim();
      articleTextDiv.appendChild(p);
    });
  }


  // ================================
  //   中央ペイン：文メタデータ
  // ================================
  const claimsContainer = document.getElementById("claimsList");
  claimsContainer.innerHTML = "";

  if (article.sentences && Array.isArray(article.sentences)) {
    article.sentences.forEach((c, idx) => {
      const card = document.createElement("div");
      card.className = `claim-card type-${c.type}`;

      card.innerHTML = `
        <div><strong>${idx + 1}.</strong> ${c.text}</div>
        <div>
          分類：
          <span class="claim-type ${c.type}">${c.type}</span>
          （信頼度: ${c.confidence ?? "N/A"}）
        </div>
      `;

      claimsContainer.appendChild(card);
    });
  }


  // ================================
  //   右ペイン：summary
  // ================================
  const summaryBox = document.getElementById("directionSummary");
  summaryBox.innerHTML = "";

  if (article.summary && article.summary.length > 0) {
    article.summary.forEach(item => {
      const li = document.createElement("li");
      li.innerText = item;
      summaryBox.appendChild(li);
    });
  } else {
    summaryBox.innerHTML = "<li>要約データなし</li>";
  }


  // ================================
  //   Future Tree
  // ================================
  const ft = document.getElementById("futureTreeText");
  ft.innerText = article.futureTree || "No Future Tree.";


  // ================================
  //   typeSummary
  // ================================
  const typeSummaryList = document.getElementById("typeSummaryList");
  typeSummaryList.innerHTML = "";

  if (article.typeSummary) {
    const ts = article.typeSummary;

    const items = [
      ["事実 (fact)", ts.fact],
      ["予測 (prediction)", ts.prediction],
      ["意見 (opinion)", ts.opinion],
      ["引用 (quote)", ts.quote]
    ];

    items.forEach(([label, count]) => {
      const li = document.createElement("li");
      li.textContent = `${label}: ${count}`;
      typeSummaryList.appendChild(li);
    });

  } else {
    typeSummaryList.innerHTML = "<li>typeSummary データなし</li>";
  }
}

</script>

</body>
</html>
