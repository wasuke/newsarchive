name: Update data/list.json automatically

on:
  push:
    paths:
      - 'data/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate data/list.json
        run: |
          node - << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const dir = 'data';

          if (!fs.existsSync(dir)) {
            console.log('data directory not found.');
            process.exit(0);
          }

          const files = fs.readdirSync(dir)
            .filter(f => f.endsWith('.json') && f !== 'list.json');

          const list = files.map(f => {
            const full = JSON.parse(fs.readFileSync(path.join(dir, f), 'utf-8'));
            return {
              id: full.articleId,
              title: full.title,
              date: full.date,
              source: full.source,
              public: full.public ?? false,
              file: `data/${f}`
            };
          });

          fs.writeFileSync(
            path.join(dir, 'list.json'),
            JSON.stringify(list, null, 2)
          );
          EOF

      - name: Commit updated list.json
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/list.json
          git commit -m "Update list.json via GitHub Actions"
          git push
