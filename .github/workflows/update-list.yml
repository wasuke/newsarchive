name: Update data/list.json automatically

on:
  push:
    branches:
      - main
    paths:
      - 'data/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate data/list.json
        run: |
          echo "Generating list.json..."

          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const dir = 'data';
          if (!fs.existsSync(dir)) {
            console.log("data folder not found");
            process.exit(0);
          }

          const files = fs.readdirSync(dir).filter(f =>
            f.endsWith('.json') && f !== 'list.json'
          );

          const list = files.map(f => {
            const json = JSON.parse(fs.readFileSync(path.join(dir, f), 'utf8'));
            return {
              id: json.articleId,
              title: json.title,
              date: json.date,
              source: json.source,
              public: json.public ?? false,
              file: `data/${f}`
            };
          });

          fs.writeFileSync(
            path.join(dir, 'list.json'),
            JSON.stringify(list, null, 2)
          );
          console.log("list.json generated.");
          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/list.json

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "Auto-update list.json"
          git push
